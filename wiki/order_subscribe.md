# 订单，订阅（骑士卡）逻辑整理



### 时间计算

> ?规则：进一法运算（满一天算一天, 不满一天也算一天）



### 订阅剩余天数判定

- 剩余天数 = 骑士卡初始天数 + 续费天数 + 修改天数 + 寄存天数 - 已过去天数
- 寄存天数 = 已结束寄存天数 + 尚在寄存中的已过去的天数
- 骑士卡初始天数 + 续费天数 直接使用`subscribe.days`
- 骑士卡未激活时，剩余时间等于骑士卡初始时间
- 若已退订或已取消，剩余时间为0



### 订阅状态判定

- [ ] test



### 续费

- 当前订阅必须为继续中并且不能为逾期

- 续费订单支付成功后需更新`subscribe.days`增加天数



### 寄存

> 条件, 当前无寄存状态
> 天数计算规则: 满一天算一天, 不满一天也算一天?

- 更新`subscribe`中`paused_at`(暂停)字段
- 插入一条暂停数据`pause`
- 结束寄存:
  - 获取寄存天数
  - 更新累加`subscribe`中`pause_days`寄存天数字段
  - 更新`pause`(`end_at`为空)中`days`(寄存天数)字段, 同时更新`end_at`字段为当前时间
  - 修改`subscribe`暂停时间为空`pause_at`



### 更改电池

> 用户未激活时禁止更改电池

用户按当前使用天数计算退款金额, 系统退款之后重新购买(类似续签, 不计佣金)

更改电池为门店端主动推送未支付订单到用户



### 修改时间

> 修改时间可为负数`days`正加负减
>
> 用户未激活时禁止修改时间

- 在`alter`中插入一条修改记录
- 修改`subscirbe`中`days`总天数

