# 订单，订阅（骑士卡）逻辑整理



### 时间计算

> ?规则：进一法运算（满一天算一天, 不满一天也算一天）



### 当前生效中的骑士卡获取条件

```
未退款, 已激活, 未退订
```



### 天数

```
总天数 = 骑士卡天数 + 改动天数 + 寄存天数 + 续费天数 + 已缴纳逾期滞纳金天数
```



```
剩余天数 = 购买天数 + 改动天数 + 寄存天数 + 已缴纳逾期滞纳金天数 - 已过时间
```



```
寄存天数 = 结束寄存当天0点 - 寄存下一天0点
```





### 订阅

- [x] 骑士卡购买成功后初始状态为未激活，` initialDays` 为初始骑士卡天数
- [x] 骑士卡未激活时，剩余时间等于骑士卡初始时间
- [ ] 若已退订或已取消，剩余时间为0



### 续费

- [x] 续费成功后增加续费天数 `renewal_days`，并增加剩余天数 `remaining`

- [x] 当前订阅必须为使用中并且不能为逾期

  

### 逾期

- [ ] 当骑手缴纳逾期费用后，订阅总天数`days`增加，剩余天数字段`remaining`修改为0，增加`overdue_days`补缴滞纳金天数



### 寄存

> 条件, 当前无寄存状态
> 天数计算规则: 满一天算一天, 不满一天也算一天?

- [ ] 更新`subscribe`中`paused_at`(暂停)字段
- [ ] 插入一条暂停数据`pause`
- [ ] 结束寄存:
  - 获取寄存天数
  - 更新累加`subscribe`中`pause_days`寄存天数字段
  - 更新`pause`(`end_at`为空)中`days`(寄存天数)字段, 同时更新`end_at`字段为当前时间
  - 修改`subscribe`暂停时间为空`pause_at`
  - 更新累加`days`总天数



### 更改电池

> 用户未激活时禁止更改电池

- [ ] 用户按当前使用天数计算退款金额, 系统退款之后重新购买(类似续签, 不计佣金)


- [ ] 更改电池为门店端主动推送未支付订单到用户




### 修改时间

> 修改时间可为负数`days`正加负减
>
> 用户未激活时禁止修改时间

- [x] 在`alter`中插入一条修改记录
- [ ] 修改`alter_days`天数
- [ ] 修改`remaining`剩余天数

